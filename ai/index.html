<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LaserOstop Tunisie - Test Chatbot</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <h1>LaserOstop Tunisie - Test Chatbot</h1>
      <p>Testez les r√©ponses du chatbot avant mise en production</p>
      <div class="header-links">
        <a href="/" class="admin-link">Calendrier</a>
        <a href="admin.html" class="admin-link">Administration</a>
      </div>
    </header>

    <div class="chat-container">
      <div id="chatMessages" class="chat-messages">
        <div class="message bot-message">
          <div class="message-avatar">ü§ñ</div>
          <div class="message-content">
            Bonjour ! üëã Bienvenue chez LaserOstop Tunisie. Je suis l'assistant virtuel. Comment puis-je vous aider ?
          </div>
        </div>
      </div>

      <div class="chat-input-container">
        <div class="quick-buttons">
          <button onclick="sendQuick('Prix')">Prix</button>
          <button onclick="sendQuick('Adresse')">Adresse</button>
          <button onclick="sendQuick('Prise de rendez-vous')">RDV</button>
          <button onclick="sendQuick('ÿ®ÿ¥ÿ≠ÿßŸÑ ÿßŸÑÿ≥ÿπÿ±')">ÿ®ÿ¥ÿ≠ÿßŸÑ</button>
          <button onclick="sendQuick('Drogue')">Drogue</button>
          <button onclick="sendQuick('52947031')">Test tel</button>
        </div>
        <div class="chat-input">
          <input type="text" id="messageInput" placeholder="Tapez un message..." autocomplete="off">
          <button id="sendBtn" onclick="sendMessage()">Envoyer</button>
        </div>
      </div>
    </div>

    <div class="info-panel">
      <h3>Informations de test</h3>
      <div id="tokenInfo" class="token-info">Tokens utilis√©s: 0</div>
      <div id="phoneInfo" class="phone-info" style="display:none">üì± Num√©ro d√©tect√©: <span id="phoneNumber"></span></div>
      <button onclick="clearChat()" class="clear-btn">Effacer la conversation</button>
    </div>
  </div>

  <script>
    const API_BASE = 'https://api.smart-cita.com/admin';
    const PASSWORD = localStorage.getItem('tunis_admin_pass') || '';
    let conversationHistory = [];
    let totalTokens = 0;

    // Prompt for password if not set, then verify
    if (!PASSWORD) {
      const pass = prompt('Mot de passe admin:');
      if (pass) {
        (async () => {
          try {
            const resp = await fetch(API_BASE + '/tunis/stats', {
              headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + pass }
            });
            if (resp.ok) {
              localStorage.setItem('tunis_admin_pass', pass);
              location.reload();
            } else {
              alert('Mot de passe incorrect');
            }
          } catch (e) {
            alert('Erreur de connexion');
          }
        })();
      }
    }

    function headers() {
      return {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + PASSWORD
      };
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      if (!message) return;

      input.value = '';
      addMessage(message, 'user');

      // Show typing indicator
      const typingId = showTyping();

      try {
        const resp = await fetch(API_BASE + '/tunis/test-chat', {
          method: 'POST',
          headers: headers(),
          body: JSON.stringify({
            message,
            history: conversationHistory
          })
        });

        removeTyping(typingId);

        if (!resp.ok) {
          if (resp.status === 401) {
            localStorage.removeItem('tunis_admin_pass');
            alert('Mot de passe incorrect');
            location.reload();
            return;
          }
          throw new Error('Erreur serveur');
        }

        const data = await resp.json();
        addMessage(data.response, 'bot');

        // Track conversation
        conversationHistory.push({ role: 'user', content: message });
        conversationHistory.push({ role: 'assistant', content: data.response });

        // Update token info
        totalTokens += data.tokens || 0;
        document.getElementById('tokenInfo').textContent = `Tokens utilis√©s: ${totalTokens}`;

        // Phone detection
        if (data.phoneDetected) {
          document.getElementById('phoneInfo').style.display = 'block';
          document.getElementById('phoneNumber').textContent = data.phoneDetected;
        }

      } catch (err) {
        removeTyping(typingId);
        addMessage('Erreur: ' + err.message, 'error');
      }
    }

    function sendQuick(text) {
      document.getElementById('messageInput').value = text;
      sendMessage();
    }

    function addMessage(text, type) {
      const container = document.getElementById('chatMessages');
      const div = document.createElement('div');
      div.className = `message ${type}-message`;

      const avatar = type === 'bot' ? 'ü§ñ' : type === 'user' ? 'üë§' : '‚ö†Ô∏è';
      div.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-content">${escapeHtml(text)}</div>
      `;

      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function showTyping() {
      const container = document.getElementById('chatMessages');
      const div = document.createElement('div');
      div.className = 'message bot-message typing';
      div.id = 'typing-' + Date.now();
      div.innerHTML = `
        <div class="message-avatar">ü§ñ</div>
        <div class="message-content typing-dots">...</div>
      `;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
      return div.id;
    }

    function removeTyping(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }

    function clearChat() {
      conversationHistory = [];
      totalTokens = 0;
      document.getElementById('chatMessages').innerHTML = `
        <div class="message bot-message">
          <div class="message-avatar">ü§ñ</div>
          <div class="message-content">Bonjour ! üëã Bienvenue chez LaserOstop Tunisie. Comment puis-je vous aider ?</div>
        </div>
      `;
      document.getElementById('tokenInfo').textContent = 'Tokens utilis√©s: 0';
      document.getElementById('phoneInfo').style.display = 'none';
    }

    function escapeHtml(text) {
      return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
    }

    // Enter key to send
    document.getElementById('messageInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
  </script>
</body>
</html>
